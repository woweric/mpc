close all
clear

%% load data

load Batch_Records3.mat Raw_Batch_data1
load Batch_Records4.mat Raw_Batch_data2

%% rearrange data

S_temp = [Raw_Batch_data1.Batch_01.S.y(1) Raw_Batch_data1.Batch_02.S.y(1) ...
    Raw_Batch_data1.Batch_03.S.y(1) Raw_Batch_data1.Batch_04.S.y(1) ...
    Raw_Batch_data1.Batch_05.S.y(1) Raw_Batch_data1.Batch_06.S.y(1) ...
    Raw_Batch_data1.Batch_07.S.y(1) Raw_Batch_data1.Batch_08.S.y(1) ...
    Raw_Batch_data1.Batch_09.S.y(1) Raw_Batch_data1.Batch_10.S.y(1) ...
    Raw_Batch_data1.Batch_11.S.y(1) Raw_Batch_data1.Batch_12.S.y(1) ...
    Raw_Batch_data1.Batch_13.S.y(1) Raw_Batch_data1.Batch_14.S.y(1) ...
    Raw_Batch_data1.Batch_15.S.y(1) Raw_Batch_data1.Batch_16.S.y(1) ...
    Raw_Batch_data1.Batch_17.S.y(1) Raw_Batch_data1.Batch_18.S.y(1) ...
    Raw_Batch_data1.Batch_19.S.y(1) Raw_Batch_data1.Batch_20.S.y(1) ...
    Raw_Batch_data2.Batch_01.S.y(1) Raw_Batch_data2.Batch_02.S.y(1) ...
    Raw_Batch_data2.Batch_03.S.y(1) Raw_Batch_data2.Batch_04.S.y(1) ...
    Raw_Batch_data2.Batch_05.S.y(1) Raw_Batch_data2.Batch_06.S.y(1) ...
    Raw_Batch_data2.Batch_07.S.y(1) Raw_Batch_data2.Batch_08.S.y(1) ...
    Raw_Batch_data2.Batch_09.S.y(1) Raw_Batch_data2.Batch_10.S.y(1) ...
    Raw_Batch_data2.Batch_11.S.y(1) Raw_Batch_data2.Batch_12.S.y(1) ...
    Raw_Batch_data2.Batch_13.S.y(1) Raw_Batch_data2.Batch_14.S.y(1) ...
    Raw_Batch_data2.Batch_15.S.y(1) Raw_Batch_data2.Batch_16.S.y(1) ...
    Raw_Batch_data2.Batch_17.S.y(1) Raw_Batch_data2.Batch_18.S.y(1) ...
    Raw_Batch_data2.Batch_19.S.y(1) Raw_Batch_data2.Batch_20.S.y(1)];
S = S_temp';

DO2_temp = [Raw_Batch_data1.Batch_01.DO2.y Raw_Batch_data1.Batch_02.DO2.y ...
    Raw_Batch_data1.Batch_03.DO2.y Raw_Batch_data1.Batch_04.DO2.y ...
    Raw_Batch_data1.Batch_05.DO2.y Raw_Batch_data1.Batch_06.DO2.y ...
    Raw_Batch_data1.Batch_07.DO2.y Raw_Batch_data1.Batch_08.DO2.y ...
    Raw_Batch_data1.Batch_09.DO2.y Raw_Batch_data1.Batch_10.DO2.y ...
    Raw_Batch_data1.Batch_11.DO2.y Raw_Batch_data1.Batch_12.DO2.y ...
    Raw_Batch_data1.Batch_13.DO2.y Raw_Batch_data1.Batch_14.DO2.y ...
    Raw_Batch_data1.Batch_15.DO2.y Raw_Batch_data1.Batch_16.DO2.y ...
    Raw_Batch_data1.Batch_17.DO2.y Raw_Batch_data1.Batch_18.DO2.y ...
    Raw_Batch_data1.Batch_19.DO2.y Raw_Batch_data1.Batch_20.DO2.y ...
    Raw_Batch_data2.Batch_01.DO2.y Raw_Batch_data2.Batch_02.DO2.y ...
    Raw_Batch_data2.Batch_03.DO2.y Raw_Batch_data2.Batch_04.DO2.y ...
    Raw_Batch_data2.Batch_05.DO2.y Raw_Batch_data2.Batch_06.DO2.y ...
    Raw_Batch_data2.Batch_07.DO2.y Raw_Batch_data2.Batch_08.DO2.y ...
    Raw_Batch_data2.Batch_09.DO2.y Raw_Batch_data2.Batch_10.DO2.y ...
    Raw_Batch_data2.Batch_11.DO2.y Raw_Batch_data2.Batch_12.DO2.y ...
    Raw_Batch_data2.Batch_13.DO2.y Raw_Batch_data2.Batch_14.DO2.y ...
    Raw_Batch_data2.Batch_15.DO2.y Raw_Batch_data2.Batch_16.DO2.y ...
    Raw_Batch_data2.Batch_17.DO2.y Raw_Batch_data2.Batch_18.DO2.y ...
    Raw_Batch_data2.Batch_19.DO2.y Raw_Batch_data2.Batch_20.DO2.y];
DO2 = DO2_temp';

Fs_temp = [Raw_Batch_data1.Batch_01.Fs.y Raw_Batch_data1.Batch_02.Fs.y ...
    Raw_Batch_data1.Batch_03.Fs.y Raw_Batch_data1.Batch_04.Fs.y ...
    Raw_Batch_data1.Batch_05.Fs.y Raw_Batch_data1.Batch_06.Fs.y ...
    Raw_Batch_data1.Batch_07.Fs.y Raw_Batch_data1.Batch_08.Fs.y ...
    Raw_Batch_data1.Batch_09.Fs.y Raw_Batch_data1.Batch_10.Fs.y ...
    Raw_Batch_data1.Batch_11.Fs.y Raw_Batch_data1.Batch_12.Fs.y ...
    Raw_Batch_data1.Batch_13.Fs.y Raw_Batch_data1.Batch_14.Fs.y ...
    Raw_Batch_data1.Batch_15.Fs.y Raw_Batch_data1.Batch_16.Fs.y ...
    Raw_Batch_data1.Batch_17.Fs.y Raw_Batch_data1.Batch_18.Fs.y ...
    Raw_Batch_data1.Batch_19.Fs.y Raw_Batch_data1.Batch_20.Fs.y ...
    Raw_Batch_data2.Batch_01.Fs.y Raw_Batch_data2.Batch_02.Fs.y ...
    Raw_Batch_data2.Batch_03.Fs.y Raw_Batch_data2.Batch_04.Fs.y ...
    Raw_Batch_data2.Batch_05.Fs.y Raw_Batch_data2.Batch_06.Fs.y ...
    Raw_Batch_data2.Batch_07.Fs.y Raw_Batch_data2.Batch_08.Fs.y ...
    Raw_Batch_data2.Batch_09.Fs.y Raw_Batch_data2.Batch_10.Fs.y ...
    Raw_Batch_data2.Batch_11.Fs.y Raw_Batch_data2.Batch_12.Fs.y ...
    Raw_Batch_data2.Batch_13.Fs.y Raw_Batch_data2.Batch_14.Fs.y ...
    Raw_Batch_data2.Batch_15.Fs.y Raw_Batch_data2.Batch_16.Fs.y ...
    Raw_Batch_data2.Batch_17.Fs.y Raw_Batch_data2.Batch_18.Fs.y ...
    Raw_Batch_data2.Batch_19.Fs.y Raw_Batch_data2.Batch_20.Fs.y];
Fs = Fs_temp';


pH_temp = [Raw_Batch_data1.Batch_01.pH.y(1) Raw_Batch_data1.Batch_02.pH.y(1) ...
    Raw_Batch_data1.Batch_03.pH.y(1) Raw_Batch_data1.Batch_04.pH.y(1) ...
    Raw_Batch_data1.Batch_05.pH.y(1) Raw_Batch_data1.Batch_06.pH.y(1) ...
    Raw_Batch_data1.Batch_07.pH.y(1) Raw_Batch_data1.Batch_08.pH.y(1) ...
    Raw_Batch_data1.Batch_09.pH.y(1) Raw_Batch_data1.Batch_10.pH.y(1) ...
    Raw_Batch_data1.Batch_11.pH.y(1) Raw_Batch_data1.Batch_12.pH.y(1) ...
    Raw_Batch_data1.Batch_13.pH.y(1) Raw_Batch_data1.Batch_14.pH.y(1) ...
    Raw_Batch_data1.Batch_15.pH.y(1) Raw_Batch_data1.Batch_16.pH.y(1) ...
    Raw_Batch_data1.Batch_17.pH.y(1) Raw_Batch_data1.Batch_18.pH.y(1) ...
    Raw_Batch_data1.Batch_19.pH.y(1) Raw_Batch_data1.Batch_20.pH.y(1) ...
    Raw_Batch_data2.Batch_01.pH.y(1) Raw_Batch_data2.Batch_02.pH.y(1) ...
    Raw_Batch_data2.Batch_03.pH.y(1) Raw_Batch_data2.Batch_04.pH.y(1) ...
    Raw_Batch_data2.Batch_05.pH.y(1) Raw_Batch_data2.Batch_06.pH.y(1) ...
    Raw_Batch_data2.Batch_07.pH.y(1) Raw_Batch_data2.Batch_08.pH.y(1) ...
    Raw_Batch_data2.Batch_09.pH.y(1) Raw_Batch_data2.Batch_10.pH.y(1) ...
    Raw_Batch_data2.Batch_11.pH.y(1) Raw_Batch_data2.Batch_12.pH.y(1) ...
    Raw_Batch_data2.Batch_13.pH.y(1) Raw_Batch_data2.Batch_14.pH.y(1) ...
    Raw_Batch_data2.Batch_15.pH.y(1) Raw_Batch_data2.Batch_16.pH.y(1) ...
    Raw_Batch_data2.Batch_17.pH.y(1) Raw_Batch_data2.Batch_18.pH.y(1) ...
    Raw_Batch_data2.Batch_19.pH.y(1) Raw_Batch_data2.Batch_20.pH.y(1)];
pH = pH_temp';


Bio_temp = [Raw_Batch_data1.Batch_01.X.y(1) Raw_Batch_data1.Batch_02.X.y(1) ...
    Raw_Batch_data1.Batch_03.X.y(1) Raw_Batch_data1.Batch_04.X.y(1) ...
    Raw_Batch_data1.Batch_05.X.y(1) Raw_Batch_data1.Batch_06.X.y(1) ...
    Raw_Batch_data1.Batch_07.X.y(1) Raw_Batch_data1.Batch_08.X.y(1) ...
    Raw_Batch_data1.Batch_09.X.y(1) Raw_Batch_data1.Batch_10.X.y(1) ...
    Raw_Batch_data1.Batch_11.X.y(1) Raw_Batch_data1.Batch_12.X.y(1) ...
    Raw_Batch_data1.Batch_13.X.y(1) Raw_Batch_data1.Batch_14.X.y(1) ...
    Raw_Batch_data1.Batch_15.X.y(1) Raw_Batch_data1.Batch_16.X.y(1) ...
    Raw_Batch_data1.Batch_17.X.y(1) Raw_Batch_data1.Batch_18.X.y(1) ...
    Raw_Batch_data1.Batch_19.X.y(1) Raw_Batch_data1.Batch_20.X.y(1) ...
    Raw_Batch_data2.Batch_01.X.y(1) Raw_Batch_data2.Batch_02.X.y(1) ...
    Raw_Batch_data2.Batch_03.X.y(1) Raw_Batch_data2.Batch_04.X.y(1) ...
    Raw_Batch_data2.Batch_05.X.y(1) Raw_Batch_data2.Batch_06.X.y(1) ...
    Raw_Batch_data2.Batch_07.X.y(1) Raw_Batch_data2.Batch_08.X.y(1) ...
    Raw_Batch_data2.Batch_09.X.y(1) Raw_Batch_data2.Batch_10.X.y(1) ...
    Raw_Batch_data2.Batch_11.X.y(1) Raw_Batch_data2.Batch_12.X.y(1) ...
    Raw_Batch_data2.Batch_13.X.y(1) Raw_Batch_data2.Batch_14.X.y(1) ...
    Raw_Batch_data2.Batch_15.X.y(1) Raw_Batch_data2.Batch_16.X.y(1) ...
    Raw_Batch_data2.Batch_17.X.y(1) Raw_Batch_data2.Batch_18.X.y(1) ...
    Raw_Batch_data2.Batch_19.X.y(1) Raw_Batch_data2.Batch_20.X.y(1)];
Bio = Bio_temp';

X = [S pH Bio DO2 Fs];

P_temp = [Raw_Batch_data1.Batch_01.P.y Raw_Batch_data1.Batch_02.P.y ...
    Raw_Batch_data1.Batch_03.P.y Raw_Batch_data1.Batch_04.P.y ...
    Raw_Batch_data1.Batch_05.P.y Raw_Batch_data1.Batch_06.P.y ...
    Raw_Batch_data1.Batch_07.P.y Raw_Batch_data1.Batch_08.P.y ...
    Raw_Batch_data1.Batch_09.P.y Raw_Batch_data1.Batch_10.P.y ...
    Raw_Batch_data1.Batch_11.P.y Raw_Batch_data1.Batch_12.P.y ...
    Raw_Batch_data1.Batch_13.P.y Raw_Batch_data1.Batch_14.P.y ...
    Raw_Batch_data1.Batch_15.P.y Raw_Batch_data1.Batch_16.P.y ...
    Raw_Batch_data1.Batch_17.P.y Raw_Batch_data1.Batch_18.P.y ...
    Raw_Batch_data1.Batch_19.P.y Raw_Batch_data1.Batch_20.P.y ...
    Raw_Batch_data2.Batch_01.P.y Raw_Batch_data2.Batch_02.P.y ...
    Raw_Batch_data2.Batch_03.P.y Raw_Batch_data2.Batch_04.P.y ...
    Raw_Batch_data2.Batch_05.P.y Raw_Batch_data2.Batch_06.P.y ...
    Raw_Batch_data2.Batch_07.P.y Raw_Batch_data2.Batch_08.P.y ...
    Raw_Batch_data2.Batch_09.P.y Raw_Batch_data2.Batch_10.P.y ...
    Raw_Batch_data2.Batch_11.P.y Raw_Batch_data2.Batch_12.P.y ...
    Raw_Batch_data2.Batch_13.P.y Raw_Batch_data2.Batch_14.P.y ...
    Raw_Batch_data2.Batch_15.P.y Raw_Batch_data2.Batch_16.P.y ...
    Raw_Batch_data2.Batch_17.P.y Raw_Batch_data2.Batch_18.P.y ...
    Raw_Batch_data2.Batch_19.P.y Raw_Batch_data2.Batch_20.P.y];
P = P_temp';

%% quality attributions
P_final = P(:,end);

%% centerlize

X0 = zscore(X);
Y0 = zscore(P_final);
% X0 = X-mean(X);
% Y0 = P_final - mean(P_final);

% save mean and std.V
Xm = mean(X);Ym = mean(P_final);


%% PLS modelling

[XL,YL,XS,YS,BETA,PCTVAR,MSE,stats] = plsregress(X0,Y0,3);
XR = XS*XL';
YR = XS*YL';

% ErrorEllipse(XS(:,[1 2]),0.95,40,2)

scatter3(XS(:,1),XS(:,2),XS(:,3),'MarkerEdgeColor',[0.8500 0.3250 0.0980])
hold on
%% model inversion
ydes = 27;
% ydes0 = (ydes-mean(P_final))/std(P_final);
ydes0 = ydes-Ym;

% general inversion
tnew = ydes0*pinv(YL');

% null space
S = XS'*XS;
[U,~,~] = svd(S*YL');
G = U(:,2:end);
% for i = -0.5:0.015:0.5
%     for j = -0.5:0.02:0.5
%         lambda = [i j];
%         tnull = lambda*G'*S;
%         t = tnew+tnull;
%         scatter3(t(1),t(2),t(3),'.','MarkerEdgeColor',[0 0.4470 0.7410])
%         hold on
%     end
% end
hold on
% (tnew+tnull)*YL' 
l = [0 0];
t1 = tnew+l*G'*S;
plot3(t1(1),t1(2),t1(3),'^k','MarkerFaceColor',[0.4940 0.1840 0.5560])
x1 = t1*XL'+Xm;
hold on

l2 = [0 0.3];
t2 = tnew+l2*G'*S;
plot3(t2(1),t2(2),t2(3),'^k','MarkerFaceColor',[0.4940 0.1840 0.5560])
x2 = t2*XL'+Xm;
hold on

l3 = [0 -0.3];
t3 = tnew+l3*G'*S;
plot3(t3(1),t3(2),t3(3),'^k','MarkerFaceColor',[0.4940 0.1840 0.5560])
x3 = t3*XL'+Xm;
hold on

l4 = [0.3 0];
t4 = tnew+l4*G'*S;
plot3(t4(1),t4(2),t4(3),'^k','MarkerFaceColor',[0.4940 0.1840 0.5560])
x4 = t4*XL'+Xm;
hold on

l5 = [-0.3 0];
t5 = tnew+l5*G'*S;
plot3(t5(1),t5(2),t5(3),'^k','MarkerFaceColor',[0.4940 0.1840 0.5560])
x5 = t5*XL'+Xm;
hold off

%% offline matrix

D = tnew*XL';
H = G'*S*XL';

X1 = [2 6.5 0.65 13]; X1m = Xm(1:4);
D1 = D(1:4);H1 = H(:,1:4);
L1 = D1*pinv(H1);
D21 = D(4:1153);D22 = H(1154:2303); X21m = Xm(4:1153);X22m = Xm(1154:2303);
H21 = H(:,4:1153);H22 = H(:,1154:2303); 
X21 = D21+L1*H21+X21m;
X22 = D22+L1*H22+X22m;




save datamat D H Xm Ym